SELECT opportunities_cstm.codigo_oportunidad_c as CODIGO,  (SELECT MAX(DATE_FORMAT(a.date_created,'%d-%m-%Y')) FROM opportunities_audit a WHERE a.parent_id = opportunities.id AND a.field_name = 'sales_stage' AND a.after_value_string = 'PROSPECCION_GENERAL' LIMIT 1) as 'PROSPECCION GENERAL' , (SELECT MAX(DATE_FORMAT(b.date_created,'%d-%m-%Y')) FROM opportunities_audit b WHERE b.parent_id = opportunities.id AND b.field_name = 'sales_stage' AND b.after_value_string = 'PROSPECCION_CONTINGENTE' LIMIT 1) as 'PROSPECCION CONTINGENTE', (SELECT MAX(DATE_FORMAT(c.date_created,'%d-%m-%Y')) FROM opportunities_audit c WHERE c.parent_id = opportunities.id AND c.field_name = 'sales_stage' AND c.after_value_string = 'EN_ESTUDIO' LIMIT 1) as 'EN_ESTUDIO', (SELECT MAX(DATE_FORMAT(d.date_created,'%d-%m-%Y')) FROM opportunities_audit d WHERE d.parent_id = opportunities.id AND d.field_name = 'sales_stage' AND d.after_value_string = 'APROBADO' LIMIT 1) as 'APROBADO', (SELECT MAX(DATE_FORMAT(e.date_created,'%d-%m-%Y')) FROM opportunities_audit e WHERE e.parent_id = opportunities.id AND e.field_name = 'sales_stage' AND e.after_value_string = 'Closed Won' LIMIT 1) as 'ADJUDICACION', (SELECT MAX(DATE_FORMAT(f.date_created,'%d-%m-%Y')) FROM opportunities_audit f WHERE f.parent_id = opportunities.id AND f.field_name = 'sales_stage' AND f.after_value_string = 'Closed Lost' LIMIT 1) as 'PERDIDO' FROM opportunities INNER JOIN opportunities_cstm ON opportunities.id = opportunities_cstm.id_c WHERE opportunities.deleted = 0 ORDER BY opportunities_cstm.codigo_oportunidad_c ASC;
